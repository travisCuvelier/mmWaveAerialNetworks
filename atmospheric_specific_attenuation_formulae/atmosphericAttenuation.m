%This function implements the computes estimates of attenuation from
%atmospheric gasses at millimeter wave frequencies. The attenuation is 
%exponential with distance and is given in dB/km. Specifically, this model
%includes contributions from water vapor (ie gaseous water, which is 
%different from fog), diatomic oxygen, and nitrogen. 

%Inputs:
%fHz = frequency (Hz), can be a vector.
%dryAirPressurehpa = Partial pressure of dry air (hPa)
%waterVaporPartialPressurehpa = Partial pressure of water vapor (hPa)
%temperatureK = Temperature (Kelvin)

%note that 
%Total barometric pressure = Partial pressure of dry air + ...
...Partial pressure of water vapor
 

%Outputs:
%attenuationdBpkM = total specific attenuation (dB per kilometer)
%dryAirAttenuationdBpkM = dry air (oxygen, nitrogen) specific...
...attenuation (dB per kilometer)
%waterVaporAttenuationdBpkM = water vapor specific attenuation...
...(dB per kilometer)

%Reference:
% "Attenuation by atmospheric gases", ITU Std. ITU-R P.676-11, 2016.


function [attenuationdBpkM,dryAirAttenuationdBpkM, waterVaporAttenuationdBpkM]  = atmosphericAttenuation(fHz,dryAirPressurehpa,waterVaporPartialPressurehpa, temperatureK)
    
    [a,b, foO2, foH2O] = loadConstants();
    
    [nr, nc] = size(fHz);
    
    if(min(nr,nc)~=1)
       error('fHz must be a vector');
    end
    
    if(nr > nc)
        fHz=fHz.';
    end
    
    f = fHz/10^9;
    p = dryAirPressurehpa;
    e = waterVaporPartialPressurehpa;
    T = temperatureK;
    theta = 300./T;
    SiO2 = a{1}*10^(-7).*p.*theta.^3.*exp(a{2}*(1-theta));
    SiH2O = b{1}*10^(-1).*e.*theta.^(3.5).*exp(b{2}*(1-theta));
    
    deltafO2 = a{3}*10^(-4).*(p.*theta.^(.8-a{4})+1.1.*e.*theta);
    deltafO2 = sqrt(deltafO2.^2+2.25.*10^-6);
    correctionFactO2= (a{5}+a{6}.*theta).*(10^(-4)).*(p+e).*theta.^.8;
    FiO2 = computeFi(f,foO2,deltafO2,correctionFactO2);
    
    deltafH2O = (b{3}.*10^(-4)).*(p.*theta.^(b{4})+e.*b{5}.*theta.^(b{6}));
    deltafH2O = .535.*deltafH2O+...
        sqrt(.217.*deltafH2O.^2+2.1316.*10^(-12).*foH2O.^2./theta);
    correctionFactH2O = 0;
    FiH2O = computeFi(f,foH2O,deltafH2O,correctionFactH2O);
    
    oxygenComponent = sum(FiO2.*SiO2);
    waterComponent = sum(FiH2O.*SiH2O);
    
    d = 5.6.*10^(-4).*(p+e).*theta.^(.8);
    
    prefactor = f.*p.*theta.^2;
    
    term1N = 6.14.*10^-5;
    term1D = d.*(1+(f./d).^2);
    term1 = term1N./term1D;
    
    term2N = 1.4.*10^(-12).*p.*theta.^1.5;
    term2D = 1+1.9.*10^(-5).*f.^(1.5);
    term2 = term2N./term2D;
    
    NDpp = prefactor.*(term1+term2); %nitrogen component
        
    dryAirAttenuationdBpkM = -.1820.*f.*(NDpp+oxygenComponent);
    
    waterVaporAttenuationdBpkM = -.1820.*f.*waterComponent;
    
    attenuationdBpkM = waterVaporAttenuationdBpkM+dryAirAttenuationdBpkM;
    
    
    if(nr > nc)
        waterVaporAttenuationdBpkM = waterVaporAttenuationdBpkM.';
        dryAirAttenuationdBpkM = dryAirAttenuationdBpkM.';
        attenuationdBpkM=attenuationdBpkM.';
    end
end

function Fi = computeFi(f,fi,deltaf,correctionFact)
    
term1N = deltaf-correctionFact.*(fi-f);
term1D = (fi-f).^2+deltaf.^2;

term2N= deltaf-correctionFact.*(fi+f);
term2D = (fi+f).^2+deltaf.^2;

prefactor = f./fi;

Fi = prefactor.*(term1N./term1D + term2N./term2D);


end

function [a,b, foO2, foH2O] = loadConstants()

a{1} = [0.975000000000000;2.52900000000000;6.19300000000000;14.3200000000000;31.2400000000000;64.2900000000000;124.600000000000;227.300000000000;389.700000000000;627.100000000000;945.300000000000;543.400000000000;1331.80000000000;1746.60000000000;2120.10000000000;2363.70000000000;1442.10000000000;2379.90000000000;2090.70000000000;2103.40000000000;2438;2479.50000000000;2275.90000000000;1915.40000000000;1503;1490.20000000000;1078;728.700000000000;461.300000000000;274;153;80.4000000000000;39.8000000000000;18.5600000000000;8.17200000000000;3.39700000000000;1.33400000000000;940.300000000000;67.4000000000000;637.700000000000;237.400000000000;98.1000000000000;572.300000000000;183.100000000000];
a{2} = [9.65100000000000;8.65300000000000;7.70900000000000;6.81900000000000;5.98300000000000;5.20100000000000;4.47400000000000;3.80000000000000;3.18200000000000;2.61800000000000;2.10900000000000;0.0140000000000000;1.65400000000000;1.25500000000000;0.910000000000000;0.621000000000000;0.0830000000000000;0.387000000000000;0.207000000000000;0.207000000000000;0.386000000000000;0.621000000000000;0.910000000000000;1.25500000000000;0.0830000000000000;1.65400000000000;2.10800000000000;2.61700000000000;3.18100000000000;3.80000000000000;4.47300000000000;5.20000000000000;5.98200000000000;6.81800000000000;7.70800000000000;8.65200000000000;9.65000000000000;0.0100000000000000;0.0480000000000000;0.0440000000000000;0.0490000000000000;0.145000000000000;0.141000000000000;0.145000000000000];
a{3} = [6.69000000000000;7.17000000000000;7.64000000000000;8.11000000000000;8.58000000000000;9.06000000000000;9.55000000000000;9.96000000000000;10.3700000000000;10.8900000000000;11.3400000000000;17.0300000000000;11.8900000000000;12.2300000000000;12.6200000000000;12.9500000000000;14.9100000000000;13.5300000000000;14.0800000000000;14.1500000000000;13.3900000000000;12.9200000000000;12.6300000000000;12.1700000000000;15.1300000000000;11.7400000000000;11.3400000000000;10.8800000000000;10.3800000000000;9.96000000000000;9.55000000000000;9.06000000000000;8.58000000000000;8.11000000000000;7.64000000000000;7.17000000000000;6.69000000000000;16.6400000000000;16.4000000000000;16.4000000000000;16;16;16.2000000000000;14.7000000000000];
a{4} = [0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0];
a{5} = [2.56600000000000;2.24600000000000;1.94700000000000;1.66700000000000;1.38800000000000;1.34900000000000;2.22700000000000;3.17000000000000;3.55800000000000;2.56000000000000;-1.17200000000000;3.52500000000000;-2.37800000000000;-3.54500000000000;-5.41600000000000;-1.93200000000000;6.76800000000000;-6.56100000000000;6.95700000000000;-6.39500000000000;6.34200000000000;1.01400000000000;5.01400000000000;3.02900000000000;-4.49900000000000;1.85600000000000;0.658000000000000;-3.03600000000000;-3.96800000000000;-3.52800000000000;-2.54800000000000;-1.66000000000000;-1.68000000000000;-1.95600000000000;-2.21600000000000;-2.49200000000000;-2.77300000000000;-0.439000000000000;0;0;0;0;0;0];
a{6} = [6.85000000000000;6.80000000000000;6.72900000000000;6.64000000000000;6.52600000000000;6.20600000000000;5.08500000000000;3.75000000000000;2.65400000000000;2.95200000000000;6.13500000000000;-0.978000000000000;6.54700000000000;6.45100000000000;6.05600000000000;0.436000000000000;-1.27300000000000;2.30900000000000;-0.776000000000000;0.699000000000000;-2.82500000000000;-0.584000000000000;-6.61900000000000;-6.75900000000000;0.844000000000000;-6.67500000000000;-6.13900000000000;-2.89500000000000;-2.59000000000000;-3.68000000000000;-5.00200000000000;-6.09100000000000;-6.39300000000000;-6.47500000000000;-6.54500000000000;-6.60000000000000;-6.65000000000000;0.0790000000000000;0;0;0;0;0;0];

b{1} = [0.113000000000000;0.00120000000000000;0.000800000000000000;2.42000000000000;0.0483000000000000;1.49900000000000;0.00110000000000000;11.5200000000000;0.00460000000000000;0.0650000000000000;0.921800000000000;0.197600000000000;10.3200000000000;0.329700000000000;1.26200000000000;0.252000000000000;0.0390000000000000;0.0130000000000000;9.70100000000000;14.7700000000000;487.400000000000;5.01200000000000;0.0713000000000000;0.302200000000000;239.600000000000;0.0140000000000000;0.147200000000000;0.0605000000000000;0.0426000000000000;0.187600000000000;8.34000000000000;0.0869000000000000;8.97200000000000;132.100000000000;22300];
b{2} = [2.14300000000000;8.73500000000000;8.35600000000000;0.668000000000000;6.18100000000000;1.54000000000000;9.82900000000000;1.04800000000000;7.35000000000000;5.05000000000000;3.59600000000000;5.05000000000000;1.40500000000000;3.59900000000000;2.38100000000000;2.85300000000000;6.73300000000000;6.73300000000000;0.114000000000000;0.114000000000000;0.159000000000000;2.20000000000000;8.58000000000000;7.82000000000000;0.396000000000000;8.18000000000000;7.98900000000000;7.91700000000000;8.43200000000000;5.11100000000000;1.44200000000000;10.2200000000000;1.92000000000000;0.258000000000000;0.952000000000000];
b{3} = [28.1100000000000;28.5800000000000;29.4800000000000;30.5000000000000;23.0300000000000;27.8300000000000;26.9300000000000;28.7300000000000;21.5200000000000;18.4500000000000;21;18.6000000000000;26.3200000000000;21.5200000000000;23.5500000000000;26.0200000000000;16.1200000000000;16.1200000000000;26;26;32.1000000000000;24.3800000000000;18;32.1000000000000;30.6000000000000;15.9000000000000;30.6000000000000;29.8500000000000;28.6500000000000;24.0800000000000;26.7000000000000;29;25.5000000000000;29.8500000000000;176.200000000000];
b{4} = [0.690000000000000;0.690000000000000;0.700000000000000;0.640000000000000;0.670000000000000;0.680000000000000;0.690000000000000;0.540000000000000;0.630000000000000;0.600000000000000;0.630000000000000;0.600000000000000;0.660000000000000;0.660000000000000;0.650000000000000;0.690000000000000;0.610000000000000;0.610000000000000;0.700000000000000;0.700000000000000;0.690000000000000;0.710000000000000;0.600000000000000;0.690000000000000;0.680000000000000;0.330000000000000;0.680000000000000;0.680000000000000;0.700000000000000;0.700000000000000;0.700000000000000;0.700000000000000;0.640000000000000;0.680000000000000;0.500000000000000];
b{5} = [4.80000000000000;4.93000000000000;4.78000000000000;5.30000000000000;4.69000000000000;4.85000000000000;4.74000000000000;5.38000000000000;4.81000000000000;4.23000000000000;4.29000000000000;4.23000000000000;4.84000000000000;4.57000000000000;4.65000000000000;5.04000000000000;3.98000000000000;4.01000000000000;4.50000000000000;4.50000000000000;4.11000000000000;4.68000000000000;4;4.14000000000000;4.09000000000000;5.76000000000000;4.09000000000000;4.53000000000000;5.10000000000000;4.70000000000000;4.78000000000000;5;4.94000000000000;4.55000000000000;30.5000000000000];
b{6} = [1;0.820000000000000;0.790000000000000;0.850000000000000;0.540000000000000;0.740000000000000;0.610000000000000;0.890000000000000;0.550000000000000;0.480000000000000;0.520000000000000;0.500000000000000;0.670000000000000;0.650000000000000;0.640000000000000;0.720000000000000;0.430000000000000;0.450000000000000;1;1;1;0.680000000000000;0.500000000000000;1;0.840000000000000;0.450000000000000;0.840000000000000;0.900000000000000;0.950000000000000;0.530000000000000;0.780000000000000;0.800000000000000;0.670000000000000;0.900000000000000;5];

foO2 = [50.4742140000000;50.9877450000000;51.5033600000000;52.0214290000000;52.5424180000000;53.0669340000000;53.5957750000000;54.1300250000000;54.6711800000000;55.2213840000000;55.7838150000000;56.2647740000000;56.3633990000000;56.9682110000000;57.6124860000000;58.3238770000000;58.4465880000000;59.1642040000000;59.5909830000000;60.3060560000000;60.4347780000000;61.1505620000000;61.8001580000000;62.4112200000000;62.4862530000000;62.9979840000000;63.5685260000000;64.1277750000000;64.6789100000000;65.2240780000000;65.7647790000000;66.3020960000000;66.8368340000000;67.3696010000000;67.9008680000000;68.4310060000000;68.9603120000000;118.750334000000;368.498246000000;424.763020000000;487.249273000000;715.392902000000;773.839490000000;834.145546000000];
foH2O = [22.2350800000000;67.8039600000000;119.995940000000;183.310091000000;321.225644000000;325.152919000000;336.222601000000;380.197372000000;390.134508000000;437.346667000000;439.150812000000;443.018295000000;448.001075000000;470.888947000000;474.689127000000;488.491133000000;503.568532000000;504.482692000000;547.676440000000;552.020960000000;556.936002000000;620.700807000000;645.866155000000;658.005280000000;752.033227000000;841.053973000000;859.962313000000;899.306675000000;902.616173000000;906.207325000000;916.171582000000;923.118427000000;970.315022000000;987.926764000000;1780];

end